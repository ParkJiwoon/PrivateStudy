# Persistence: 영속성

영속성이란 개념은 일반적으로 데이터를 생성한 프로그램이 종료되어도 데이터는 사라지지 않는 특성을 의미합니다.

JPA 에서 영속성이란 Entity 를 영구적으로 저장해주는 특성을 말합니다.

<br>

# Persist: 영속화

Entity 를 영속성 컨텍스트에 저장하는 것을 영속화라고 합니다.

영속화 하는 순간 `@Id` 값이 자동으로 생성됩니다.

`JpaRepository.save` 를 호출하면 해당 엔티티를 영속화합니다.

<br>

# Persistence Context: 영속성 컨텍스트

- Entity 를 영구적으로 저장하는 영역
- Entity Manager 하나당 영속성 컨텍스트 하나 존재

<br>

## 1. 1차 캐시

- 영속성 컨텍스트에 존재하는 캐시
- Entity 를 식별자 값 (보통 `@Id`) 값으로 구분
- Key-Value 형식으로 저장 (`@Id - Entity`)

<br>

## 2. 동일성 보장

- 영속성 컨텍스트를 조회해서 얻은 Entity 는 항상 동일한 객체를 반환 (동일한 식별자인 경우)

<br>

## 3. 쓰기지연 수행
- 트랜잭션 범위 안에서 동작
- 트랜잭션 commit 전, 영속성 컨텍스트의 sql저장소에 생성쿼리를 저장
- flush() 수행 후, 저장했던 생성쿼리를 데이터베이스에 반영 (데이터베이스 동기화)
- 트랜잭션 commit 

<br>

## 4. 변경 감지 (Dirty Checking)
- 영속성 컨텍스트에 있는 모든 엔티티를 스냅샷과 비교해서 수정된 엔티티를 찾는다. 
- 수정된 엔티티를 확인하면, 수정 쿼리를 만들어 sql 저장소에 저장
- flush() 수행 후, 저장했던 수정 쿼리를 데이터베이스에 반영 (데이터베이스 동기화)
- 트랜잭션 commit

<br>

# Flush

JPA 는 Entity 를 영속성 컨텍스트에서 관리합니다.

영속성 컨텍스트에 있는 값들을 데이터베이스에 반영하는 것을 Flush 라고 합니다.

데이터베이스에 변경 내용을 SQL 로 전달하지 않고 트랜잭션만 커밋하면 어떤 데이터도 데이터베이스에 반영되지 않습니다.

따라서 트랜잭션을 커밋하기 전에 꼭 플러시를 호출해서 영속성 컨텍스트의 변경 내용을 데이터베이스에 반영해야 합니다.

<br>

# Reference

- [Hibernate: flush 와 commit 의 차이](https://stackoverflow.com/questions/14581865/hibernate-flush-and-commit)